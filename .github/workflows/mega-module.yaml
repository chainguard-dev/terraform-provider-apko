name: Test Chainguard Images
on:
  pull_request:
    branches: ['main']
  push:
    branches: ['main']

permissions:
  contents: read
  id-token: write
  actions: read

concurrency:
  group: presubmit-build-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build-the-world:
    runs-on: ubuntu-latest

    steps:
    - uses: chainguard-dev/actions/setup-chainctl@main
      with:
        # This allows chainguard-dev/terraform-provider-apko to push images to chainreg.biz/tf-apko.pub
        # We maintain this identity here:
        # https://github.com/chainguard-dev/mono/blob/main/env/chainguard-staging/iac/chainguard-public.tf
        environment: chainops.dev
        identity: 7bd3499071c496a9d1dc27156fedf9a5b82cfe4a/6689fc1916e8bf87

    - uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
      with:
        path: tf-apko

    - working-directory: tf-apko
      run: go build .

    - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
      with:
        repository: chainguard-images/images
        path: images

    - uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.3.*'
        terraform_wrapper: false

    - uses: chainguard-dev/actions/setup-kind@main
      with:
        k8s-version: v1.24.x
        registry-authority: registry.local:5000

    - working-directory: images
      env:
        TF_VAR_target_repository: chainreg.biz/tf-apko.pub
      run: |
        terraform init

        cat > ~/.terraformrc <<EOF
        provider_installation {
          dev_overrides {
            "chainguard-dev/apko" = "${{ github.workspace }}/tf-apko"
          }
        }
        EOF

        terraform apply -auto-approve
